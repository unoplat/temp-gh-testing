name: Develop Branch Action

on:
  pull_request_target:
    types: [opened]
    branches:
      - develop
  workflow_dispatch:

jobs:
  dev-pr:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    outputs:
      should_run_next_job: ${{ steps.read_json.outputs.dockerImageScan }}
      current-image-matrix: ${{ steps.set-image-matrix.outputs.image-matrix}}
      timestamp: ${{ steps.timestamp.outputs.timeStamp }}

    steps:
    - name: Checkout our repository
      uses: actions/checkout@v4
      with:
        ref: main
    - name: Read JSON Config
      id: read_json
      uses: actions/github-script@v5
      with:
        script: |
          const fs = require('fs');
          const config = JSON.parse(fs.readFileSync('.github/github-action-config.json', 'utf8'));
          core.setOutput('config', config);
          core.setOutput('dockerImageScan',config.dockerImageScan)
          
    - name: Conditional Docker Image Scan
      working-directory: charts
      if: ${{ steps.read_json.outputs.dockerImageScan == 'true'}}
      env:
        HELM_VALUES_FILE_PATH: ${{ fromJson(steps.read_json.outputs.config).upStreamChartName }}/values.yaml
      run: |
        arch=$(echo "${{ runner.arch }}" | awk '{print tolower($0)}')
        os=$(echo "${{ runner.os }}" | awk '{print tolower($0)}')
        echo $arch
        echo $os
        if [ "$arch" = "x64" ]; then
          arch="amd64"
        fi
        LATEST_RELEASE=$(curl -s https://api.github.com/repos/unoplat/unoplat-ci-cd-scripts/releases/latest | jq -r '.tag_name' | xargs)
        echo "Latest release info: $LATEST_RELEASE"
        wget https://github.com/unoplat/unoplat-ci-cd-scripts/releases/download/$LATEST_RELEASE/image-scan-$LATEST_RELEASE-$os-$arch.tar.gz
        tar -xzf image-scan-$LATEST_RELEASE-$os-$arch.tar.gz
        if [ -f docker_images.json ]; then
          rm docker_images.json
        fi
        ./image-scan
        rm image-scan
        rm image-scan*.tar.gz
          
    - name: Generate Matrix
      id: set-image-matrix
      uses: actions/github-script@v5
      if: ${{ steps.read_json.outputs.dockerImageScan == 'true' }}
      with:
        script: |
          const fs = require('fs');
          const data = JSON.parse(fs.readFileSync('charts/docker_images.json', 'utf8'));
          let keysArray = Object.keys(data);
          core.setOutput('image-matrix', JSON.stringify(keysArray));
# use this file later for summarising container security reports
    - name: Set timestamp
      id: timestamp
      if: ${{ steps.read_json.outputs.dockerImageScan == 'true' }}
      run: |
        TIMESTAMP=$(date +'%Y%m%d%H%M')
        echo "::set-output name=timeStamp::${TIMESTAMP}"  
        mkdir reports/container-security-analysis/container-security-analysis-${TIMESTAMP}
        touch reports/container-security-analysis/container-security-analysis-${TIMESTAMP}/README.md
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git pull origin
        git add reports/container-security-analysis/container-security-analysis-${TIMESTAMP}
        git commit -m "Add timestamp directory for container security analysis ${TIMESTAMP}"
        git push origin main

  use-container-scan-matrix:
    needs: dev-pr
    runs-on: ubuntu-latest
    if: ${{ needs.dev-pr.outputs.should_run_next_job == 'true' }}
    strategy:
      matrix:
        images:  ${{fromJson(needs.dev-pr.outputs.current-image-matrix)}}    
    steps:
      - name: Checkout our repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Create an empty json file for current scan with current timestamp
        id: createfile
        run: |
          timestamp=$(date +%Y%m%d%H%M)
          export IMAGE_NAME=$(echo ${{ matrix.images }}  | awk -F'/' '{print $NF}' | cut -d ':' -f 1)
          echo "::set-output name=docker_image_name::$IMAGE_NAME"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.1.0

      - name: Generate Trivy Report 
        uses: aquasecurity/trivy-action@master
        with: 
          scan-type: 'image' 
          format: 'json' 
          output: "reports/container-security-analysis/container-security-analysis-${{needs.dev-pr.outputs.timestamp}}/${{ steps.createfile.outputs.docker_image_name }}-container-report.json" 
          ignore-unfixed: true 
          vuln-type: "os"
          severity: 'CRITICAL,HIGH' 
          image-ref: ${{ matrix.images }} 
          
      - name: Archive Trivy Reports
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.createfile.outputs.docker_image_name }}-container-report
          path: reports/container-security-analysis/container-security-analysis-${{needs.dev-pr.outputs.timestamp}}/${{ steps.createfile.outputs.docker_image_name }}-container-report.json
              # check whether there are any OS package vulnerabilities 
      - name: Check vulnerability count 
        id: vuln_count 
        run: | 
          report_file=reports/container-security-analysis/container-security-analysis-${{needs.dev-pr.outputs.timestamp}}/${{ steps.createfile.outputs.docker_image_name }}-container-report.json
          vuln_count=$(jq 'if .Results then [.Results[] | select(.Class=="os-pkgs" and .Vulnerabilities!=null) | .Vulnerabilities[]] | length else 0 end' "$report_file") 
          echo "vuln_count=$vuln_count"
          echo "vuln_count=$vuln_count" >> $GITHUB_OUTPUT  

                     
      - name: Run Copa action 
        if: steps.vuln_count.outputs.vuln_count != '0' 
        id: copa 
        # using main for testing purposes 
        # use a tag (such as v1 or v1.0.1) at a bare minimum 
        # recommendation is to pin to a digest for security and stability 
        # and rely on dependabot for digest/version updates 
        uses: project-copacetic/copa-action@v1.2.0
        with: 
          image: ${{ matrix.images }} 
          image-report: "reports/container-security-analysis/container-security-analysis-${{needs.dev-pr.outputs.timestamp}}/${{ steps.createfile.outputs.docker_image_name }}-container-report.json" 
          patched-tag: "patched"
          timeout: 15m

      - name: Extract Image name and tag
        if: steps.vuln_count.outputs.vuln_count != '0' 
        id: image_name_and_tag
        run: |
          IMAGE_NAME=$(echo ${{ steps.copa.outputs.patched-image }} | awk -F':' '{print $1}')
          IMAGE_TAG=$(echo ${{ steps.copa.outputs.patched-image }} | awk -F':' '{print $2}')
          echo "::set-output name=image_name::$IMAGE_NAME"
          echo "::set-output name=image_tag::$IMAGE_TAG"   
                   
      - name: Build and publish "head" Docker image
        if: steps.vuln_count.outputs.vuln_count != '0' 
        uses: VaultVulp/gp-docker-action@1.6.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }} # Provide GITHUB_TOKEN to login into the GitHub Packages
          image-name: ${{ steps.image_name_and_tag.outputs.image_name }} # Provide Docker image name
          image-tag: ${{ steps.copa.outputs.patched-image }} # Provide Docker image tag

  commit-reports:
    needs: [use-container-scan-matrix,dev-pr]
    runs-on: ubuntu-latest
    if: ${{ needs.dev-pr.outputs.should_run_next_job == 'true' }} 
    steps:
      - name: Checkout our repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: reports/container-security-analysis/container-security-analysis-${{needs.dev-pr.outputs.timestamp}}

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

      - name: Commit and Push Changes
        run: |
          if git status --porcelain; then
            git pull origin main
            git add reports/*
            git commit -m "Add scan results"
            git push origin main
          else
            echo "No changes to commit."
          fi
  scan-and-patch-images:
    needs: [commit-reports,dev-pr]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout our repository
        uses: actions/checkout@v4
        with:
          ref: main
