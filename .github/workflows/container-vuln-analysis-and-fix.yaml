name: Develop Branch Action

# todo: add container vulnerability scan

on:
  pull_request_target:
    types: [opened]
    branches:
      - develop
  workflow_dispatch:

jobs:
  dev-pr-merge:
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
    - name: Checkout our repository
      uses: actions/checkout@v4
      with:
        ref: main
    - name: Read JSON Config
      id: read_json
      uses: actions/github-script@v5
      with:
        script: |
          const fs = require('fs');
          const config = JSON.parse(fs.readFileSync('.github/github-action-config.json', 'utf8'));
          core.setOutput('config', config);
    - name: Conditional Docker Image Scan
      working-directory: charts
      if: ${{ fromJson(steps.read_json.outputs.config).dockerImageScan }}
      env:
        HELM_VALUES_FILE_PATH: ${{ fromJson(steps.read_json.outputs.config).upStreamChartName }}/values.yaml
      run: |
        arch=$(echo "${{ runner.arch }}" | awk '{print tolower($0)}')
        os=$(echo "${{ runner.os }}" | awk '{print tolower($0)}')
        echo $arch
        echo $os
        wget https://github.com/unoplat/unoplat-ci-cd-scripts/releases/download/v1.2.5/image-scan-v1.2.5-$os-$arch.tar.gz
        tar -xzf image-scan-v1.2.5-$os-$arch.tar.gz
        if [ -f docker_images.json ]; then
          rm docker_images.json
        fi
        ./image-scan

    - name: Push changes to our repository
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        git pull origin
        git add charts/docker_images.json
        git commit -m "added charts and scan results"
        echo main
        git push origin main